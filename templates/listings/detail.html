{% extends "anyAuthenticationLayout.html" %}

{% block title %}Detalles de arriendo{% endblock %}

{% block content %}
<h2>{{ object.location_text }}</h2>
<p><b>Precio:</b> ${{ object.price }}</p>
<p><b>Zona:</b> {{ object.zone.name }} - {{ object.zone.city }}</p>
<p><b>Número de habitaciones:</b> {{ object.rooms }}</p>
<p><b>Baños:</b> {{ object.bathrooms }}</p>
<p><b>Precio de servicios:</b> ${{ object.utilities_price }}</p>
<p><b>Disponible:</b> {{ object.available|yesno:"Sí,No" }}</p>
<p><b>Visitas:</b> {{ object.views }}</p>
<p><b>Popularidad:</b> {{ object.popularity }}</p>

{% if can_add_favorite or can_remove_favorite %}
    <hr>
    <p><b>Favoritos:</b> {{ favorited_by }}</p>
    {% if can_add_favorite %}
        <form action="{% url 'listings:addFavorite' object.pk %}" method="post">
            {% csrf_token %}
            <button type="submit">Añadir a Favoritos</button>
        </form>
    {% elif can_remove_favorite %}
        <form action="{% url 'listings:removeFavorite' object.pk %}" method="post">
            {% csrf_token %}
            <button type="submit">Quitar de Favoritos</button>
        </form>
    {% endif %}
{% endif %}
<hr>

<h3>Comentarios</h3>

<ul>
  {% for comment in comments %}
    <li style="margin-bottom: 0.75rem;">
      <strong>
        {{ comment.author.get_full_name|default:comment.author.username }}
      </strong><br>
      <small>
        {{ comment.created_at|date:"d/m/Y H:i" }}
      </small><br>
      {{ comment.text|linebreaks }}

      {# Botón de eliminar (solo el autor del comentario) #}
      {% if user.is_authenticated and comment.author_id == user.id %}
        <form action="{% url 'listings:comment_delete' comment.pk %}"
              method="post"
              style="display:inline;">
          {% csrf_token %}
          <button type="submit">Eliminar</button>
        </form>
      {% endif %}

      {# REPLIES (respuestas al comentario) #}
      {% if comment.replies.all %}
        <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
          {% for reply in comment.replies.all %}
            <li style="margin-bottom: 0.5rem;">
              <strong>
                {{ reply.author.get_full_name|default:reply.author.username }}
              </strong><br>
              <small>
                {{ reply.created_at|date:"d/m/Y H:i" }}
              </small><br>
              {{ reply.text|linebreaks }}

              {% if user.is_authenticated and reply.author_id == user.id %}
                <form action="{% url 'listings:comment_delete' reply.pk %}"
                      method="post"
                      style="display:inline;">
                  {% csrf_token %}
                  <button type="submit">Eliminar</button>
                </form>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      {# FORMULARIO PARA RESPONDER A ESTE COMENTARIO #}
      {% if can_comment %}
        <form action="{% url 'listings:comment_create' object.pk %}"
              method="post"
              style="margin-top: 0.5rem;">
          {% csrf_token %}
          {# usamos solo el campo de texto del mismo form #}
          {{ comment_form.text.errors }}
          {{ comment_form.text }}
          {# campo oculto con el id del comentario padre #}
          <input type="hidden" name="parent" value="{{ comment.id }}">
          <button type="submit">Responder</button>
        </form>
      {% endif %}
    </li>
  {% empty %}
    <p>No hay comentarios todavía.</p>
  {% endfor %}
</ul>

<hr>

{# FORMULARIO PARA NUEVO COMENTARIO (no respuesta) #}
{% if can_comment %}
  <h4>Agregar comentario</h4>
  <form action="{% url 'listings:comment_create' object.pk %}" method="post">
    {% csrf_token %}
    {{ comment_form.non_field_errors }}
    {{ comment_form.text.errors }}
    {{ comment_form.text }}
    {# sin parent -> comentario raíz #}
    <button type="submit">Enviar</button>
  </form>
{% else %}
  <p>
    Debes iniciar sesión como estudiante o ser el arrendador dueño del anuncio
    para poder comentar.
  </p>
{% endif %}

<br>

<h3>Reseñas</h3>

<ul>
  {% for review in reviews %}
    <li style="margin-bottom: 0.75rem;">
      <strong>
        {{ review.author.user.get_full_name|default:review.author.user.username }}
      </strong><br>
      <small>{{ review.created_at|date:"d/m/Y H:i" }}</small><br>
      {{ review.rating }}
      {{ review.text|linebreaks }}

      {% if user.is_authenticated and review.author.user.id == user.id %}
        <form action="{% url 'listings:review_delete' review.pk %}" method="post">
          {% csrf_token %}
          <button type="submit">Eliminar</button>
        </form>
      {% endif %}
  {% empty %}
    <p>No hay reseñas todavía.</p>
  {% endfor %}
</ul>

<hr>
{% if can_review %}
  <h4>Dejar reseña</h4>
  <form action="{% url 'listings:review_create' object.pk %}" method="post">
    {% csrf_token %}
    {{ review_form.text.errors }}
    {{ review_form.text }}
    {{ review_form.rating }}
    <br>
    <button type="submit">Enviar</button>
  </form>
{% else %}
  <p>
    Debes iniciar sesión como estudiante y no haber dejado una reseña en esta publicación antes para poder dejar una reseña.
  </p>
{% endif %}

<br>

<a href="{% url back_url %}">Regresar</a>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.reply-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const id = this.dataset.commentId;
      const form = document.querySelector(
        '.reply-form[data-parent-id="' + id + '"]'
      );
      if (form) {
        form.style.display =
          form.style.display === 'none' || form.style.display === '' ?
          'block' : 'none';
      }
    });
  });
});
</script>
{% endblock %}
