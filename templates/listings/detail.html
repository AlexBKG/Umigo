{% extends "anyAuthenticationLayout.html" %}

{% block title %}Detalles de arriendo{% endblock %}

{% block content %}
<h2>{{ object.location_text }}</h2>
<p><b>Precio:</b> ${{ object.price }}</p>
<p><b>Zona:</b> {{ object.zone.name }} - {{ object.zone.city }}</p>
<p><b>N칰mero de habitaciones:</b> {{ object.rooms }}</p>
<p><b>Ba침os:</b> {{ object.bathrooms }}</p>
<p><b>Precio de servicios:</b> ${{ object.utilities_price }}</p>
<p><b>Disponible:</b> {{ object.available|yesno:"S칤,No" }}</p>
<p><b>Visitas:</b> {{ object.views }}</p>
<p><b>Popularidad:</b> {{ object.popularity }}</p>

{% if can_add_favorite or can_remove_favorite %}
    <hr>
    <p><b>Favoritos:</b> {{ favorited_by }}</p>
    {% if can_add_favorite %}
        <form action="{% url 'listings:addFavorite' object.pk %}" method="post">
            {% csrf_token %}
            <button type="submit">A침adir a Favoritos</button>
        </form>
    {% elif can_remove_favorite %}
        <form action="{% url 'listings:removeFavorite' object.pk %}" method="post">
            {% csrf_token %}
            <button type="submit">Quitar de Favoritos</button>
        </form>
    {% endif %}
    
    {# Report Listing Button - Only for students #}
    {% if user.is_authenticated and user.student_profile %}
        <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#reportListingModal">
            游댮 Reportar Publicaci칩n
        </button>
    {% endif %}
{% endif %}
<hr>

{# Landlord Information with Report Button #}
<p><b>Arrendador:</b> 
    {{ object.owner.user.get_full_name|default:object.owner.user.username }}
    {% if user.is_authenticated and user != landlord_user and not user.is_staff %}
        {% if user.student_profile or user.landlord_profile %}
            <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#reportLandlordModal">
                游리 Reportar Arrendador
            </button>
        {% endif %}
    {% endif %}
</p>
<hr>

<h3>Comentarios</h3>

<ul>
  {% for comment in comments %}
    <li style="margin-bottom: 0.75rem;">
      <strong>
        {{ comment.author.get_full_name|default:comment.author.username }}
      </strong>
      
      {# Report Comment Author Button - Can't report yourself or staff #}
      {% if user.is_authenticated and user != comment.author and not comment.author.is_staff %}
        {% if user.student_profile or user.landlord_profile %}
          <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#reportCommentUser{{ comment.id }}Modal">
            游리 Reportar Usuario
          </button>
        {% endif %}
      {% endif %}
      
      <br>
      <small>{{ comment.created_at|date:"d/m/Y H:i" }}</small>
      <br>
      
      {{ comment.text|linebreaks }}

      {# Bot칩n de eliminar (solo el autor del comentario) #}
      {% if user.is_authenticated and comment.author_id == user.id %}
        <form action="{% url 'listings:comment_delete' comment.pk %}"
              method="post"
              style="display:inline;">
          {% csrf_token %}
          <button type="submit">Eliminar</button>
        </form>
      {% endif %}

      {# REPLIES (respuestas al comentario) #}
      {% if comment.replies.all %}
        <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
          {% for reply in comment.replies.all %}
            <li style="margin-bottom: 0.5rem;">
              <strong>
                {{ reply.author.get_full_name|default:reply.author.username }}
              </strong><br>
              <small>
                {{ reply.created_at|date:"d/m/Y H:i" }}
              </small><br>
              {{ reply.text|linebreaks }}

              {% if user.is_authenticated and reply.author_id == user.id %}
                <form action="{% url 'listings:comment_delete' reply.pk %}"
                      method="post"
                      style="display:inline;">
                  {% csrf_token %}
                  <button type="submit">Eliminar</button>
                </form>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      {# FORMULARIO PARA RESPONDER A ESTE COMENTARIO #}
      {% if can_comment %}
        <form action="{% url 'listings:comment_create' object.pk %}"
              method="post"
              style="margin-top: 0.5rem;">
          {% csrf_token %}
          {# usamos solo el campo de texto del mismo form #}
          {{ comment_form.text.errors }}
          {{ comment_form.text }}
          {# campo oculto con el id del comentario padre #}
          <input type="hidden" name="parent" value="{{ comment.id }}">
          <button type="submit">Responder</button>
        </form>
      {% endif %}
    </li>
  {% empty %}
    <p>No hay comentarios todav칤a.</p>
  {% endfor %}
</ul>

<hr>

{# FORMULARIO PARA NUEVO COMENTARIO (no respuesta) #}
{% if can_comment %}
  <h4>Agregar comentario</h4>
  <form action="{% url 'listings:comment_create' object.pk %}" method="post">
    {% csrf_token %}
    {{ comment_form.non_field_errors }}
    {{ comment_form.text.errors }}
    {{ comment_form.text }}
    {# sin parent -> comentario ra칤z #}
    <button type="submit">Enviar</button>
  </form>
{% else %}
  <p>
    Debes iniciar sesi칩n como estudiante o ser el arrendador due침o del anuncio
    para poder comentar.
  </p>
{% endif %}

<br>

{# Report Modals - Bootstrap 5 (no custom JavaScript needed) #}

{# Modal: Report Listing #}
{% if user.is_authenticated and user.student_profile %}
<div class="modal fade" id="reportListingModal" tabindex="-1" aria-labelledby="reportListingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reportListingModalLabel">游댮 Reportar Publicaci칩n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'inquiries:report_listing' object.pk %}">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.path }}">
        <div class="modal-body">
          <p>쮼st치s seguro de reportar esta publicaci칩n?</p>
          <p><strong>{{ object.location_text }}</strong></p>
          
          <div class="mb-3">
            <label for="reportListingType" class="form-label">Tipo de reporte:</label>
            <select class="form-select" id="reportListingType" name="report_type" required>
              <option value="FRAUD">Fraude</option>
              <option value="HARASSMENT">Acoso</option>
              <option value="INAPPROPRIATE_LANGUAGE">Lenguaje inapropiado</option>
              <option value="MISLEADING_CONTENT">Contenido enga침oso</option>
              <option value="OTHER" selected>Otro</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="reportListingReason" class="form-label">Motivo del reporte:</label>
            <textarea class="form-control" id="reportListingReason" name="reason" rows="4" minlength="10" maxlength="255" required placeholder="Describe el motivo de tu reporte (m칤n. 10, m치x. 255 caracteres)"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Enviar Reporte</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{# Modal: Report Landlord #}
{% if user.is_authenticated and landlord_user and user != landlord_user and not landlord_user.is_staff %}
  {% if user.student_profile or user.landlord_profile %}
  <div class="modal fade" id="reportLandlordModal" tabindex="-1" aria-labelledby="reportLandlordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reportLandlordModalLabel">游리 Reportar Arrendador</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post" action="{% url 'inquiries:report_user' landlord_user.pk %}">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.path }}">
          <div class="modal-body">
            <p>쮼st치s seguro de reportar a este arrendador?</p>
            <p><strong>{{ landlord_user.get_full_name|default:landlord_user.username }}</strong></p>
            
            <div class="mb-3">
              <label for="reportLandlordType" class="form-label">Tipo de reporte:</label>
              <select class="form-select" id="reportLandlordType" name="report_type" required>
                <option value="FRAUD">Fraude</option>
                <option value="HARASSMENT">Acoso</option>
                <option value="INAPPROPRIATE_LANGUAGE">Lenguaje inapropiado</option>
                <option value="MISLEADING_CONTENT">Contenido enga침oso</option>
                <option value="OTHER" selected>Otro</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="reportLandlordReason" class="form-label">Motivo del reporte:</label>
              <textarea class="form-control" id="reportLandlordReason" name="reason" rows="4" minlength="10" maxlength="255" required placeholder="Describe el motivo de tu reporte (m칤n. 10, m치x. 255 caracteres)"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-warning">Enviar Reporte</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
{% endif %}

{# Modals: Report Comment Authors #}
{% for comment in comments %}
  {% if user.is_authenticated and user != comment.author and not comment.author.is_staff %}
    {% if user.student_profile or user.landlord_profile %}
    <div class="modal fade" id="reportCommentUser{{ comment.id }}Modal" tabindex="-1" aria-labelledby="reportCommentUser{{ comment.id }}ModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="reportCommentUser{{ comment.id }}ModalLabel">游리 Reportar Usuario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form method="post" action="{% url 'inquiries:report_user' comment.author.pk %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.path }}">
            <div class="modal-body">
              <p>쮼st치s seguro de reportar a este usuario?</p>
              <p><strong>{{ comment.author.get_full_name|default:comment.author.username }}</strong></p>
              
              <div class="mb-3">
                <label for="reportCommentUser{{ comment.id }}Type" class="form-label">Tipo de reporte:</label>
                <select class="form-select" id="reportCommentUser{{ comment.id }}Type" name="report_type" required>
                  <option value="FRAUD">Fraude</option>
                  <option value="HARASSMENT">Acoso</option>
                  <option value="INAPPROPRIATE_LANGUAGE">Lenguaje inapropiado</option>
                  <option value="MISLEADING_CONTENT">Contenido enga침oso</option>
                  <option value="OTHER" selected>Otro</option>
                </select>
              </div>
              
              <div class="mb-3">
                <label for="reportCommentUser{{ comment.id }}Reason" class="form-label">Motivo del reporte:</label>
                <textarea class="form-control" id="reportCommentUser{{ comment.id }}Reason" name="reason" rows="4" minlength="10" maxlength="255" required placeholder="Describe el motivo de tu reporte (m칤n. 10, m치x. 255 caracteres)"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-warning">Enviar Reporte</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  {% endif %}
{% endfor %}

<script>
// Limpiar formularios cuando se cierran los modales
document.addEventListener('DOMContentLoaded', function() {
    // Obtener todos los modales
    var modals = document.querySelectorAll('.modal');
    
    modals.forEach(function(modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            // Limpiar todos los formularios dentro del modal
            var forms = modal.querySelectorAll('form');
            forms.forEach(function(form) {
                form.reset();
            });
        });
    });
});
</script>


<h3>Rese침as</h3>

<ul>
  {% for review in reviews %}
    <li style="margin-bottom: 0.75rem;">
      <strong>
        {{ review.author.user.get_full_name|default:review.author.user.username }}
      </strong><br>
      <small>{{ review.created_at|date:"d/m/Y H:i" }}</small><br>
      {{ review.rating }}
      {{ review.text|linebreaks }}

      {% if user.is_authenticated and review.author.user.id == user.id %}
        <form action="{% url 'listings:review_delete' review.pk %}" method="post">
          {% csrf_token %}
          <button type="submit">Eliminar</button>
        </form>
      {% endif %}
  {% empty %}
    <p>No hay rese침as todav칤a.</p>
  {% endfor %}
</ul>

<hr>
{% if can_review %}
  <h4>Dejar rese침a</h4>
  <form action="{% url 'listings:review_create' object.pk %}" method="post">
    {% csrf_token %}
    {{ review_form.text.errors }}
    {{ review_form.text }}
    {{ review_form.rating }}
    <br>
    <button type="submit">Enviar</button>
  </form>
{% else %}
  <p>
    Debes iniciar sesi칩n como estudiante y no haber dejado una rese침a en esta publicaci칩n antes para poder dejar una rese침a.
  </p>
{% endif %}

<br>

<a href="{% url back_url %}">Regresar</a>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.reply-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const id = this.dataset.commentId;
      const form = document.querySelector(
        '.reply-form[data-parent-id="' + id + '"]'
      );
      if (form) {
        form.style.display =
          form.style.display === 'none' || form.style.display === '' ?
          'block' : 'none';
      }
    });
  });
});
</script>
{% endblock %}
