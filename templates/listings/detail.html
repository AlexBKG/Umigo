{% extends "anyAuthenticationLayout.html" %}

{% block title %}Detalles de arriendo{% endblock %}

{% block content %}
<h2>{{ object.location_text }}</h2>
<p><b>Precio:</b> ${{ object.price }}</p>
<p><b>Zona:</b> {{ object.zone.name }} - {{ object.zone.city }}</p>
<p><b>Cuartos:</b> {{ object.rooms }}</p>
<p><b>Baños:</b> {{ object.bathrooms }}</p>
<p><b>Precio de servicios:</b> ${{ object.utilities_price }}</p>
<p><b>Disponible:</b> {{ object.available|yesno:"Si,No" }}</p>
<p><b>Vistas:</b> {{ object.views }}</p>

{% if object.photos.all %}
    <h3>Fotos del arriendo</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        {% for photo in object.photos.all %}
            <div>
                <img src="{{ photo.image.url }}"
                     alt="Foto {{ forloop.counter }} de {{ object.location_text }}"
                     style="max-width: 250px; height: auto; border: 1px solid #ccc;">
            </div>
        {% endfor %}
    </div>
{% else %}
    <p>Este arriendo todavía no tiene fotos.</p>
{% endif %}

<hr>
<h3>Comentarios</h3>

<ul>
  {% for comment in comments %}
    <li style="margin-bottom: 0.75rem;">
      <strong>
        {{ comment.author.get_full_name|default:comment.author.username }}
      </strong><br>
      <small>
        {{ comment.created_at|date:"d/m/Y H:i" }}
      </small><br>
      {{ comment.text|linebreaks }}

      {# Botón de eliminar (solo el autor del comentario) #}
      {% if user.is_authenticated and comment.author_id == user.id %}
        <form action="{% url 'listings:comment_delete' comment.pk %}"
              method="post"
              style="display:inline;">
          {% csrf_token %}
          <button type="submit">Eliminar</button>
        </form>
      {% endif %}

      {# REPLIES (respuestas al comentario) #}
      {% if comment.replies.all %}
        <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
          {% for reply in comment.replies.all %}
            <li style="margin-bottom: 0.5rem;">
              <strong>
                {{ reply.author.get_full_name|default:reply.author.username }}
              </strong><br>
              <small>
                {{ reply.created_at|date:"d/m/Y H:i" }}
              </small><br>
              {{ reply.text|linebreaks }}

              {% if user.is_authenticated and reply.author_id == user.id %}
                <form action="{% url 'listings:comment_delete' reply.pk %}"
                      method="post"
                      style="display:inline;">
                  {% csrf_token %}
                  <button type="submit">Eliminar</button>
                </form>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      {# FORMULARIO PARA RESPONDER A ESTE COMENTARIO #}
      {% if can_comment %}
        <form action="{% url 'listings:comment_create' object.pk %}"
              method="post"
              style="margin-top: 0.5rem;">
          {% csrf_token %}
          {# usamos solo el campo de texto del mismo form #}
          {{ comment_form.text.errors }}
          {{ comment_form.text }}
          {# campo oculto con el id del comentario padre #}
          <input type="hidden" name="parent" value="{{ comment.id }}">
          <button type="submit">Responder</button>
        </form>
      {% endif %}
    </li>
  {% empty %}
    <p>No hay comentarios todavía.</p>
  {% endfor %}
</ul>

<hr>

{# FORMULARIO PARA NUEVO COMENTARIO (no respuesta) #}
{% if can_comment %}
  <h4>Agregar comentario</h4>
  <form action="{% url 'listings:comment_create' object.pk %}" method="post">
    {% csrf_token %}
    {{ comment_form.non_field_errors }}
    {{ comment_form.text.errors }}
    {{ comment_form.text }}
    {# sin parent -> comentario raíz #}
    <button type="submit">Enviar</button>
  </form>
{% else %}
  <p>
    Debes iniciar sesión como estudiante o ser el arrendador dueño del anuncio
    para poder comentar.
  </p>
{% endif %}

<a href="{% url back_url %}">Regresar</a>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.reply-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const id = this.dataset.commentId;
      const form = document.querySelector(
        '.reply-form[data-parent-id="' + id + '"]'
      );
      if (form) {
        form.style.display =
          form.style.display === 'none' || form.style.display === '' ?
          'block' : 'none';
      }
    });
  });
});
</script>
{% endblock %}
